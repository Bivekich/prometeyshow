# Отчёт: исправление данных Sanity в продакшене (12.08.2025)

## Контекст
- В режиме разработки (`npm run dev`) сайт корректно получал данные из Sanity и отображал картинки.
- На продакшене отображались неверные данные, а в логах появлялись ошибки при попытке отрендерить PDF как изображение и падения на странице блога.

## Симптомы
- Логи сервера:
  - `The requested resource isn't a valid image for /documents/*.pdf received text/html; charset=utf-8`
  - `TypeError: Cannot read properties of undefined (reading 'name')` в `app/blog/[slug]/page.js`
- Визуально: некорректные данные на страницах (моки вместо реальных), превью документов не отображались.

## Корневая причина
- В `lib/sanity.ts` логика считала, что продакшен нужно всегда считать «отключённым Sanity»:
  - `isSanityDisabled = DISABLE_SANITY === 'true' || NODE_ENV === 'production'` → в проде включались мок-данные и фолбэк‑картинки.
  - В `urlFor` изображения в проде всегда подменялись заглушками.
- В «Документах» пытались отрендерить PDF через `<img>`, что приводило к ошибке «not a valid image».
- На странице блога категория читалась как `post.category.name` без проверки наличия связи, приводя к падению при пустой категории.

## Изменения
- `lib/sanity.ts`:
  - Используем моки только при явном `DISABLE_SANITY=true` (убран форс в продакшене).
  - В `urlFor` возвращаем заглушку только если Sanity отключён или источник пустой; иначе используем Sanity image builder (работает в проде).
- `components/sections/about/Documents.tsx`:
  - Для ссылок, оканчивающихся на `.pdf`, показываем превью `public/placeholder-image.svg`, а по клику открываем оригинальный PDF в новой вкладке.
- `app/blog/[slug]/page.tsx`:
  - Безопасный доступ к категории: `post.category?.name`.

Коммит: `fix(prod): stop forcing mock data in production; use Sanity image builder; avoid rendering PDFs as images; guard blog category name access` (hash: 29f49c7).

## Влияние
- В продакшене используются реальные данные из Sanity, изображения генерируются корректно.
- Документы PDF больше не пытаются рендериться как изображения; открываются корректно по ссылке.
- Страница блога не падает при отсутствии категории.

## Требования к окружению
- Переменные окружения должны быть заданы:
  - `NEXT_PUBLIC_SANITY_PROJECT_ID`
  - `NEXT_PUBLIC_SANITY_DATASET`
  - `NEXT_PUBLIC_SANITY_API_VERSION`
- Не устанавливать `DISABLE_SANITY=true` в продакшене, иначе вернутся мок‑данные.

## Деплой и сборка
- Собрать и запустить:
  - `npm run build && npm start`
- Примечание: в ограниченной среде без сети возможна ошибка загрузки Google Fonts при сборке. На сервере с доступом к сети сборка проходит штатно.

## Проверка
- Открыть страницы:
  - `/about` → секция «Документы»: отображаются превью, PDF открываются в новой вкладке.
  - `/blog/[slug]` → страница не падает, категория отображается при наличии.
  - Визуально убедиться, что данные соответствуют содержимому Sanity (не мок‑данные).

## Возможные улучшения
- Убрать неиспользуемый `rewrites` для `/images` в `next.config.ts` (для `public/` не требуется и может путать маршрутизацию).
- При необходимости вернуться к `next/image` и настроить `remotePatterns` для домена Sanity.
- Добавить e2e/интеграционные проверки для страницы документов и блога.

